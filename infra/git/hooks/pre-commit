#!/usr/bin/env bash

# Pre-commit hook to check for sensitive keywords
# This hook prevents commits that contain certain keywords

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

GIT_ROOT=$(git rev-parse --show-toplevel)
BLACKWORDS_FILE="$GIT_ROOT/infra/git/blackwords"

if [ ! -f "$BLACKWORDS_FILE" ]; then
    echo -e "${RED}ERROR: Blackwords file not found at $BLACKWORDS_FILE${NC}"
    echo "Please create the file and define sensitive keywords (one per line)."
    echo "Commit rejected!"
    exit 1
fi

KEYWORDS=()
while IFS= read -r line; do
    # Skip empty lines and lines starting with #
    if [ -n "$line" ] && [[ ! "$line" =~ ^[[:space:]]*# ]]; then
        KEYWORDS+=("$line")
    fi
done <"$BLACKWORDS_FILE"

if [ ${#KEYWORDS[@]} -eq 0 ]; then
    echo -e "${RED}ERROR: No keywords defined in $BLACKWORDS_FILE${NC}"
    echo "The blackwords file is empty or contains only comments."
    echo "Please add sensitive keywords to the file (one per line)."
    echo "Commit rejected!"
    exit 1
fi

# Get list of files to be committed (staged files)
FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$FILES" ]; then
    exit 0
fi

FOUND=0

echo "Checking for sensitive keywords..."

for FILE in $FILES; do
    for KEYWORD in "${KEYWORDS[@]}"; do
        if echo "$FILE" | grep -qi "$KEYWORD"; then
            if [ $FOUND -eq 0 ]; then
                echo -e "${RED}ERROR: Sensitive keywords found in staged files!${NC}"
                echo ""
                FOUND=1
            fi
            echo -e "${YELLOW}  File: $FILE${NC}"
            echo -e "${RED}  Keyword found in FILENAME: $KEYWORD${NC}"
            echo ""
        fi
    done

    # Skip if file doesn't exist (deleted files)
    if [ ! -f "$FILE" ]; then
        continue
    fi

    for KEYWORD in "${KEYWORDS[@]}"; do
        if grep -qi "$KEYWORD" "$FILE"; then
            if [ $FOUND -eq 0 ]; then
                echo -e "${RED}ERROR: Sensitive keywords found in staged files!${NC}"
                echo ""
                FOUND=1
            fi
            echo -e "${YELLOW}  File: $FILE${NC}"
            echo -e "${RED}  Keyword found in CONTENT: $KEYWORD${NC}"
            # Show the line where keyword was found
            grep -ni "$KEYWORD" "$FILE" | head -n 3
            echo ""
        fi
    done
done

if [ $FOUND -eq 1 ]; then
    echo -e "${RED}Commit rejected!${NC}"
    echo "Please remove the sensitive keywords from your files before committing."
    exit 1
fi

echo "No sensitive keywords found. Proceeding with commit..."
exit 0
